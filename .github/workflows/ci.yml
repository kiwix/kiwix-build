name: CI

on:
 push:
 schedule:
   - cron: '0 1 * * *'

jobs:
  Macos:
    strategy:
      fail-fast: false
      matrix:
        config:
          - native_dyn
          - native_static
          - native_mixed
    runs-on: macos-13
    env:
      SSH_KEY: /tmp/id_rsa
      OS_NAME: macos
    steps:
    - name: Set Xcode version (15.0.1)
      # https://github.com/actions/runner-images/blob/main/images/macos/macos-13-Readme.md#xcode
      run: sudo xcode-select -s /Applications/Xcode_15.0.1.app
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: Install packages
      run:
        brew install automake # ninja
    - name: Install python modules
      run: |
        pip3 install meson pytest requests distro paramiko
        pip3 install --no-deps $GITHUB_WORKSPACE
    - name: secret
      shell: bash
      run: |
        echo "${{secrets.ssh_key}}" > $SSH_KEY
        chmod 600 $SSH_KEY
    - name: Ensure base deps
      shell: bash
      run: |
        cd $HOME
        $GITHUB_WORKSPACE/.github/scripts/ensure_base_deps.py
      env:
        COMPILE_CONFIG: ${{matrix.config}}
    - name: Compile all deps
      shell: bash
      run: |
        cd $HOME
        $GITHUB_WORKSPACE/.github/scripts/compile_all_deps.py
      env:
        COMPILE_CONFIG: ${{matrix.config}}
    - name: Build projects
      shell: bash
      run: |
        cd $HOME
        $GITHUB_WORKSPACE/.github/scripts/build_projects.py
      env:
        COMPILE_CONFIG: ${{matrix.config}}
    - name: Upload failure logs
      if: failure()
      run: $GITHUB_WORKSPACE/.github/scripts/upload_failure_logs.py
      env:
        COMPILE_CONFIG: ${{matrix.config}}
